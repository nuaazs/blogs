## CPU架构和工作原理

计算机有5大基本组成部分：运算器、控制器、存储器、输入和输出。

运算器和控制器封装到一起，加上寄存器组和CPU内部总线构成中央处理器CPU。其根本任务就是执行指令。对于计算机来说都是0、1组成的序列，CPU 从逻辑上可以划分为3个模块：控制单元、运算单元和存储单元。这三个部分由CPU总线连接起来。

![](https://shengbucket.oss-cn-hangzhou.aliyuncs.com/pics/asLfH.jpg)

CPU的运行原理：控制单元在时序脉冲的作用下，将指令计数器里所指向额指令地址（这个地址是在内存里的）送到地址总线上，然后CPU将这个地址里的指令读取到指令寄存器进行译码。对于执行指令过程中所需要用到的数据，会将数据地址也送到地址总线，然后CPU把数据读取到CPU内部的存储单元（内部寄存器）暂存起来，最后命令运算单元对数据进行加工处理。周而复始一直执行下去。



## 多核CPU和多CPU

### 架构

多个物理CPU，CPU通过总线进行通信，效率比较低。

![](https://shengbucket.oss-cn-hangzhou.aliyuncs.com/pics/7dydS.jpg)

多核CPU，不同的核通过L2 cache进行通信，存储和外设通过总线与CPU通信。

![](https://shengbucket.oss-cn-hangzhou.aliyuncs.com/pics/yYUrz.jpg)

## CPU的缓存

CPU缓存是位于CPU与内存之间的临时数据交换器，它的容量比内存小得多，但是交换速度却比内存要快得多。

CPU缓存一般直接跟CPU芯片集成或位于主板总线互连的独立芯片上。

![](https://shengbucket.oss-cn-hangzhou.aliyuncs.com/pics/PWV8O.jpg)

随着多核CPU的发展，CPU缓存通常分成了三个级别：`L1`,`L2`,`L3`。级别越小越接近CPU，所以速度也更快，同时也代表着容量越小。L1 是最接近CPU的, 它容量最小（例如：`32K`），速度最快，每个核上都有一个 L1 缓存，L1 缓存每个核上其实有两个 L1 缓存, 一个用于存数据的 L1d Cache（Data Cache），一个用于存指令的 L1i Cache（Instruction Cache）。L2 缓存 更大一些（例如：`256K`），速度要慢一些, 一般情况下每个核上都有一个独立的L2 缓存; L3 缓存是三级缓存中最大的一级（例如3MB），同时也是最慢的一级, 在同一个CPU插槽之间的核共享一个 L3 缓存。

读取数据过程。就像数据库缓存一样，首先在最快的缓存中找数据，如果缓存没有命中(Cache miss) 则往下一级找, 直到三级缓存都找不到时，向内存要数据。一次次地未命中，代表取数据消耗的时间越长。

计算过程。程序以及数据被加载到主内存；指令和数据被加载到CPU的高速缓；CPU执行指令，把结果写到高速缓存；高速缓存中的数据写回主内存。



## 进程和线程

**进程** process：程序执行一次的过程，是一个动态概念，是程序在执行过程中分配和管理资源的地本单位。

**线程** thread：CPU调度和分派的基本单位，它可以同属一个进程的其他的线程共享进程所拥有的全部资源。

**联系**：线程是进程的一部分，一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程。

**区别**：理解他们的区别，从资源使用的角度出发。（所谓的资源就是计算机里的中央处理器、内存、网络、文件等等）。进程是操作系统资源分配的基本单位，而线程是任务调度和执行的基本单位。

**在开销方面**：每个进程都有独立的代码和数据空间（程序上下文），程序之间的切换会有较大的开销；线程共享代码和数据空间，每个线程都有自己独立的运行栈和程序计数器（PC），线程之间切换的开销小。

**所处环境**：在操作系统中能同时运行多个进程（程序）；而在同一个进程（程序）中有多个线程同时执行（通过CPU调度，在每个时间片中只有一个线程执行）。

内存分配方面：系统在运行的时候会为每个进程分配不同的内存空间；而对线程而言，除CPU外，系统不会为线程分配内存（线程所使用的资源来自其所属进程的资源），线程组之间只能共享资源。

**包含关系**：没有线程的进程可以看作是单线程的，如果一个进程内有多个线程，则执行过程不是一条线的，二十多条线（线程）共同完成的；线程是进程的一部分，所以线程也被称为轻量级进程。

## 进程和线程在多核CPU，多CPU中的运行关系

操作系统会拆分CPU为一段段时间的运行片，轮流分配给不同的程序。对于多CPU，多个进程可以并行在多个CPU中计算，当然也会存在进程切换；对于单CPU，多个进程在这个单CPU中是并发运行的，根据时间片读取上下文+执行程序+保存上下文。同一个进程同一个时间段只能在一个CPU中运行，如果进程数小于CPU数，那么未使用的CPU将会空闲。

**多线程的概念主要有两种**：一种是用户态多线程；一种是内核态多线程。

对于内核态多线程，在操作系统内核的支持下可以在多核下并行运行；

对于多核CPU，进程中的多线程并行执行。对于单核CPU，多线程在单CPU中并发执行，根据时间片切换线程。同一个线程同一时间段只能在一个CPU内核中运行，如果线程数少于CPU内核数，那么多余的内核空闲。